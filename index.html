<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Musicas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 100px;
    }
    #main, #go-section, #countdown, #info {
      display: none;
    }
    #countdown {
      font-size: 80px;
      margin-top: 50px;
    }
  </style>
</head>
<body>

  <div id="main">
    <input type="text" id="playlist-url" placeholder="Klistra in Spotify playlist-URL här" size="50">
    <br><br>
    <button onclick="submitPlaylist()">OK</button>
  </div>

  <div id="go-section">
    <h1>Musicas</h1>
    <button onclick="startCountdown()">GO!</button>
    <p style="margin-top: 20px; font-size: 14px;">Tryck på “Tillbaka” efter att låten spelats klart</p>
  </div>

  <div id="countdown"></div>
  <div id="info"></div>

  <script>
    const clientId = "27a09eb146a942a7adcbf5507822bacd";
    const redirectUri = window.location.origin + window.location.pathname;
    const scopes = "playlist-read-private";

    let accessToken = localStorage.getItem("spotify_token");
    if (!accessToken) {
      const hash = window.location.hash;
      if (hash) {
        const params = new URLSearchParams(hash.substring(1));
        accessToken = params.get("access_token");
        if (accessToken) {
          localStorage.setItem("spotify_token", accessToken);
          window.location.hash = "";
        }
      } else {
        const authUrl = `https://accounts.spotify.com/authorize?response_type=token&client_id=${clientId}&scope=${scopes}&redirect_uri=${encodeURIComponent(redirectUri)}`;
        window.location.href = authUrl;
      }
    }

    let playlistTracks = [];

    if (!sessionStorage.getItem('playlistEnteredToday')) {
      document.getElementById('main').style.display = 'block';
    } else {
      document.getElementById('go-section').style.display = 'block';
    }

    async function submitPlaylist() {
      const url = document.getElementById('playlist-url').value;
      if (url.includes('spotify.com/playlist')) {
        sessionStorage.setItem('playlistEnteredToday', 'true');
        document.getElementById('main').style.display = 'none';
        document.getElementById('go-section').style.display = 'block';
        playlistTracks = await fetchPlaylistTracks(url);
      } else {
        alert("Ogiltig Spotify playlist-URL");
      }
    }

    async function fetchPlaylistTracks(playlistUrl) {
      const playlistId = playlistUrl.split("/playlist/")[1].split("?")[0];
      const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
        headers: {
          Authorization: `Bearer ${accessToken}`
        }
      });

      if (!response.ok) {
        alert("Kunde inte ladda spår. Har du rätt behörighet?");
        return [];
      }

      const data = await response.json();
      return data.items.map(item => {
        const track = item.track;
        return {
          artist: track.artists[0].name,
          title: track.name,
          year: track.album.release_date.split("-")[0],
          url: track.external_urls.spotify
        };
      });
    }

    function startCountdown() {
      document.getElementById('go-section').style.display = 'none';
      const countdown = document.getElementById('countdown');
      countdown.style.display = 'block';
      let number = 3;

      const interval = setInterval(() => {
        countdown.innerText = number;
        number--;
        if (number < 0) {
          clearInterval(interval);
          playRandomTrack();
        }
      }, 1000);
    }

    function playRandomTrack() {
      document.getElementById('countdown').style.display = 'none';

      if (playlistTracks.length === 0) {
        alert("Inga spår hittades.");
        return;
      }

      const track = playlistTracks[Math.floor(Math.random() * playlistTracks.length)];
      window.location.href = track.url;

      setTimeout(() => {
        const info = document.getElementById('info');
        info.style.display = 'block';
        info.innerHTML = `<h2>${track.artist} - ${track.title} (${track.year})</h2>`;
      }, 3000);
    }
  </script>
</body>
</html>
